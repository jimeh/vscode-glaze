/**
 * TypeScript code generator for theme backgrounds.
 */
import * as fs from 'fs';
import * as path from 'path';
import type { ExtractedTheme, ElementBackgrounds } from './types';

/**
 * Formats an ElementBackgrounds object as TypeScript code.
 */
function formatBackgrounds(backgrounds: ElementBackgrounds): string {
  const parts = [`editor: '${backgrounds.editor}'`];

  if (backgrounds.titleBar) {
    parts.push(`titleBar: '${backgrounds.titleBar}'`);
  }
  if (backgrounds.statusBar) {
    parts.push(`statusBar: '${backgrounds.statusBar}'`);
  }
  if (backgrounds.activityBar) {
    parts.push(`activityBar: '${backgrounds.activityBar}'`);
  }

  if (parts.length === 1) {
    return `{ ${parts[0]} }`;
  }

  return `{\n      ${parts.join(',\n      ')},\n    }`;
}

/**
 * Escapes a theme name for use as an object key.
 */
function formatThemeName(name: string): string {
  // If the name contains special characters, quote it
  if (/[^a-zA-Z0-9_]/.test(name)) {
    return `'${name.replace(/'/g, "\\'")}'`;
  }
  return name;
}

/**
 * Generates TypeScript code for the THEME_BACKGROUNDS constant.
 */
export function generateTypeScriptCode(
  themes: ExtractedTheme[],
  existingThemes?: Map<string, ExtractedTheme>
): string {
  // Merge with existing themes (preserving manually added ones)
  const mergedThemes = new Map<string, ExtractedTheme>();

  // Add existing themes first
  if (existingThemes) {
    for (const [name, theme] of existingThemes) {
      mergedThemes.set(name, theme);
    }
  }

  // Add/update with extracted themes
  for (const theme of themes) {
    mergedThemes.set(theme.name, theme);
  }

  // Sort alphabetically for stable diffs
  const sortedNames = Array.from(mergedThemes.keys()).sort((a, b) =>
    a.localeCompare(b, undefined, { sensitivity: 'base' })
  );

  const timestamp = new Date().toISOString();
  const lines: string[] = [
    '/**',
    ' * Auto-generated theme background colors.',
    ` * Generated: ${timestamp}`,
    ' * ',
    ' * This file is auto-generated by scripts/extract-theme-colors.',
    ' * Do not edit manually - changes will be overwritten.',
    ' * ',
    ' * To add custom themes, use the patina.theme.backgroundColors setting.',
    ' */',
    '',
    "import type { ThemeBackground } from './backgrounds';",
    '',
    'export const GENERATED_THEME_BACKGROUNDS: Record<string, ThemeBackground>' +
      ' = {',
  ];

  for (const name of sortedNames) {
    const theme = mergedThemes.get(name)!;
    const formattedName = formatThemeName(name);
    const backgrounds = formatBackgrounds(theme.backgrounds);

    lines.push(`  ${formattedName}: {`);
    lines.push(`    backgrounds: ${backgrounds},`);
    lines.push(`    kind: '${theme.kind}',`);
    lines.push('  },');
  }

  lines.push('};');
  lines.push('');

  return lines.join('\n');
}

/**
 * Writes the generated TypeScript code to a file.
 */
export function writeOutputFile(outputPath: string, content: string): void {
  const dir = path.dirname(outputPath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  fs.writeFileSync(outputPath, content);
}

/**
 * Generates a summary report of extracted themes.
 */
export function generateReport(themes: ExtractedTheme[]): string {
  const darkThemes = themes.filter((t) => t.kind === 'dark');
  const lightThemes = themes.filter((t) => t.kind === 'light');

  const lines: string[] = [
    '# Theme Extraction Report',
    '',
    `Total themes extracted: ${themes.length}`,
    `  - Dark themes: ${darkThemes.length}`,
    `  - Light themes: ${lightThemes.length}`,
    '',
    '## Themes with per-element backgrounds',
    '',
  ];

  const themesWithElements = themes.filter(
    (t) =>
      t.backgrounds.titleBar ||
      t.backgrounds.statusBar ||
      t.backgrounds.activityBar
  );

  if (themesWithElements.length === 0) {
    lines.push('No themes with per-element backgrounds found.');
  } else {
    for (const theme of themesWithElements) {
      const elements: string[] = [];
      if (theme.backgrounds.titleBar) elements.push('titleBar');
      if (theme.backgrounds.statusBar) elements.push('statusBar');
      if (theme.backgrounds.activityBar) elements.push('activityBar');
      lines.push(`- ${theme.name}: ${elements.join(', ')}`);
    }
  }

  lines.push('');
  return lines.join('\n');
}
